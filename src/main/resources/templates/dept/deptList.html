<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<!--引用通用head--->
<head th:replace="common/commonHeader::common_header(~{::title},~{::link},~{})">
    <title>部门列表</title>
    <link rel="stylesheet" th:href="@{/webjars/zTree/css/zTreeStyle/zTreeStyle.css}"/>
</head>
<body>
<!--引用通用JS-->
<div th:replace="common/commonFoot::foot(~{::script})">
    <script th:src="@{/webjars/jquery-validation/jquery.validate.min.js}"></script>
    <script th:src="@{/webjars/zTree/js/jquery.ztree.all.js}"></script>
    <script th:src="@{/js/common.js}" ></script>
    <script th:src="@{/js/zTreeCommon.js}" ></script>
</div>
<div class="wrapper wrapper-content ">
    <div class="panel-heading">
        <h3 class="panel-title">
            部门管理
        </h3>
    </div>
    <div class="col-sm-12">
        <div class="ibox">
            <div class="ibox-body">
                <div class="fixed-table-toolbar">
                    <div class="columns pull-left">
                        <button onclick="toAdd()" class="btn btn-primary">
                            <i class="fa fa-plus hidden" aria-hidden="true"></i>添加
                        </button>
                        <button onclick="batchDelete()" class="btn btn-primary">
                            <i class="fa fa-trash" aria-hidden="true"></i>删除
                        </button>
                    </div>
                </div>
                <div id="tableMain">
                    <div>
                        搜索：<input type="text" id="deptName" class="empty" style="width: 80px;margin-left: 3px;font-weight: normal;" placeholder="请输入部门名称"/>
                    </div>
                    <ul id="dataTree" class="ztree">

                    </ul>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
    </div>
</div>

<script type="text/javascript">
    // 第三步初始化Datatables
    $(function() {
        initDept();
    });
    //设置
    var setting={
        check: {
            enable: true,
            autoCheckTrigger: true,   //true / false 分别表示 触发 / 不触发 事件回调函数
            chkStyle: "checkbox",
            chkboxType: { "Y": "p", "N": "s" }   //勾选 checkbox 对于父子节点的关联关系
        },
        view:{
            showLine: true,
            showIcon: false
        },
        data: {
            simpleData: {
                enable: true
            }
        },
        callback: {
            onClick:"",
            beforeCheck: beforeCheckParam,
            onCheck: onCheckParam
        }
    }

    function beforeCheckParam(treeId, treeNode) {
        if (treeNode.isParent) {
            toastr.warning("请选择子节点！",0);
            return false;
        }
    }
    //获取选中的节点
    function onCheckParam(e, treeId, treeNode) {
        var treeObj=$.fn.zTree.getZTreeObj("dataTree"),
            nodes=treeObj.getCheckedNodes(true),
            v="";
        for(var i=0;i<nodes.length;i++){
            v+=nodes[i].name + ",";
        }
        var id_close = '';
        for(var i=0;i<nodes.length;i++){
            //判断是不是根节点
            if(nodes[i].pId == null){
                //判断根节点有没有下级了，没有下级，需要选中跟节点
                if(nodes[i].children == undefined){
                    id_close = id_close + ',' + nodes[i].id;
                }
            }else{
                id_close = id_close + ',' + nodes[i].id
            }
        }
        return id_close;
    }
    //ajax调用初始化方法
    function initDept(){
        $.ajax({
            url: "/dept/list",
            type: "post",
            data: {},
            dataType: "json",
            success: function (data) {
                var zNodes=[];
                var datas=eval(data);
                datas.forEach(function(dept){
                    var node=new Object();
                    node.id=dept.deptId;
                    node.pId=dept.parentId;
                    node.name=dept.deptName;
                    zNodes.push(node);
                });
                //初始化tree树
                var zTree = $.fn.zTree.init($("#dataTree"), setting,  zNodes);
                zTreeAutoMatch('dataTree','#deptName',null,true); //初始化模糊搜索方法
                zTree.expandAll(true);   //true 节点全部展开、false节点收缩
            },
            error: function (msg) {

            }
        });
    }



    //批量删除
    function batchDelete(){
        var treeObj=$.fn.zTree.getZTreeObj("dataTree");
        var rows=treeObj.getCheckedNodes(true);
        if (rows.length == 0) {
            toastr.warning("请选择要删除的数据");
            return;
        }
        var ids = [];
        // 遍历所有选择的行数据，取每条数据对应的ID
        $.each(rows, function(i, row) {
            ids[i] = row['id'];
        });
        console.log(rows+"--"+ids);
        if(confirm("确定删除选中的部门信息？")){
            $.ajax(
                {
                    type: "POST",
                    url: "/dept/batchDelete",//url请求的地址
                    cache: false,  //禁用缓存
                    data: {deptIds:ids},  //传入组装的参数
                    dataType: "json",
                    traditional:true,
                    success: function (result) {
                        if(result.success){
                            toastr.success('删除成功！');
                            window.location.reload();
                        }
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        toastr.warning('删除失败！'+errorThrown);
                    }
                }
            );
        }
    }
    //单个删除
    function del(data){
       if(confirm("确定删除本部门信息？")){
            $.ajax(
                {
                    type: "POST",
                    url: "/dept/delete",//url请求的地址
                    cache: false,  //禁用缓存
                    data: {deptId:data.deptId},  //传入组装的参数
                    dataType: "json",
                    success: function (result) {
                        if(result.success){
                            toastr.success('删除成功！');
                            window.location.reload();
                        }
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        toastr.warning('删除失败！'+errorThrown);
                    }
                }
            );
       }
    }
    function toAdd(){
        var url="/dept/add";
        openDialogView("新增部门",url,"800px","600px")
    }
    //添加下级
    function addChild(obj) {
        var url="/dept/add?deptId="+obj.deptId;
        openDialogView("新增部门",url,"800px","600px")
    }
</script>
</body>
</html>