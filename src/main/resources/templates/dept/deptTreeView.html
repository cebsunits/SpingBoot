<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<!--引用通用head--->
<head th:replace="common/commonHeader::common_header(~{::title},~{::link},~{})">
    <title>部门树信息</title>
    <link rel="stylesheet" th:href="@{/webjars/bootstrap-glyphicons/css/bootstrap-glyphicons.css}"/>
    <link rel="stylesheet" th:href="@{/webjars/bootstrap-treeview/bootstrap-treeview.min.css}"/>
</head>
<body>
<!--引用通用JS-->
<div th:replace="common/commonFoot::foot(~{::script})">
    <script th:src="@{/webjars/bootstrap-treeview/bootstrap-treeview.min.js}"></script>
    <script th:src="@{/webjars/jquery-validation/jquery.validate.min.js}"></script>
</div>
<div class="graphic-container">
    <div class="wrapper wrapper-content">
        <div class="row">
            <div class="col-sm-12">
                <div class="form-group">
                    <label for="input_search" clas="sr-only">快捷搜索：</label>
                    <input type="text" class="form-control" id="input_search" placeholder="请输入要查询的部门名称">
                </div>
                <div class="form-group">
                    <button type="button" class="btn btn-success" id="btn-search">搜索</button>
                    <button type="button" class="btn btn-default" id="btn-clear-search">清除</button>
                </div>
            </div>
        </div>
        <!--显示结果-->
        <div class="row">
            <div class="col-sm-12">
                <div id="search-output">

                </div>
            </div>
        </div>
        <!--显示树-->
        <div class="row">
            <div class="col-sm-12">
                <div class="ibox-content">
                    <div id="deptTree"></div>
                </div>
                <div class="form-group hidden">
                    <div class="col-sm-12 col-sm-offset-12">
                        <button type="button" id="btn_select" class="btn btn-primary" onclick="selectDepts()">提交</button>
                        <button type="button" class="btn btn-secondary" onclick="javascript:window.top.close()">关闭</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">
    var deptTree;
    $(function() {
        //获取树结构
        getTreeData();
        $('#btn-search').click=search();
        $('#btn-search').keyup=search();
        $('#btn-clear-search').click=clearSearch();
    })
    //获取树信息
    function getTreeData() {
        //ajax请求数据方法
        $.ajax({
            type: "POST",
            url: "/sys/dept/deptTree",//url请求的地址
            cache: false,  //禁用缓存
            data: {},  //传入组装的参数
            dataType: "json",
            success: function (result) {
                if(result.success){
                    toastr.success('查询成功！');
                    deptTree= loadTree(result.data);
                }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                toastr.warning('查询失败！');
                alert("status:" + XMLHttpRequest.status + ",readyState:" + XMLHttpRequest.readyState + ",textStatus:" + textStatus);
            }
        });
    }
    //加载树
    function loadTree(data) {
        deptTree= $("#deptTree").treeview(
            {
                data:data,
                level:5,
                nodeIcon: "glyphicon",
                selectedIcon: 'glyphicon',
                showCheckbox:true,
                multiSelect: true,
                selectable:true,
                //一个节点被选择。
                onNodeSelected:function onNodeSelected(event, data){
                    console.log("onNodeSelected"+data)
                },
                //取消选择一个节点。
                onNodeUnselected:function nodeUnselected(event, data){
                    console.log("onNodeUnselected"+data)
                },
                //一个节点被checked。
                onNodeChecked :function nodeChecked (event, data){
                    console.log("onNodeChecked"+data)
                    console.log(JSON.stringify(data))
                },
                //一个节点被unchecked。
                onNodeUnchecked:function nodeUnchecked(event, data){
                    console.log("onNodeUnchecked"+data)
                    console.log(JSON.stringify(data))
                }
            }
        );
        return deptTree;
    }
    //获取查询结果
    function search(){
        if(deptTree!=undefined){
            var pattern = $.trim($('#input-search').val());
            var options = {
                ignoreCase: false,
                exactMatch: false,
                revealResults: true
            };
            var results = deptTree.treeview('search', [pattern, options]);
            var output = '<p>' + results.length + ' 匹配的搜索结果</p>';
            $.each(results,
                function(index, result) {
                    output += '<p>- <span style="color:red;">' + result.text + '</span></p>';
                });
            $('#search-output').html(output);
        }
    }
    //清空
    function clearSearch() {
        if(deptTree!=undefined){
            deptTree.treeview('clearSearch');
            $('#input-search').val('');
            $('#search-output').html('');
            $('#deptTree').treeview('collapseAll', {
                silent: false //设置初始化节点关闭
            });
        }
    }
    //点击提交时把选择的数据返回给父页面
    function selectDepts() {
        var objs = $("#deptTree").find(":checkbox:checked");
        //选择的部门数组
        var depts=new Array();
        $.each(objs,function () {
            console.log(JSON.stringify($(this)))
            $(this).next().nodeId();
            //获取text 部门名称
            var deptName=$(this).next().text();
        });
        console.log(objs+"----")
        var depts=deptTree.getChecked;
        console.log("----"+depts)
    }
</script>
</body>
</html>